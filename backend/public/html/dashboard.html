<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Session - Metasophy Study Buddy</title>
    <!-- Google Fonts for playful timer -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Fredoka+One&family=Nunito:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: #ffffff;
color: #333;
min-height: 100vh;
display: flex;
overflow-x: hidden;
}

/* Left Sidebar */
.sidebar {
width: 80px;
background: #f8f9fa;
border-right: 1px solid #e9ecef;
display: flex;
flex-direction: column;
align-items: center;
padding: 100px 0 0 0;
gap: 30px;
margin-right: 2rem;
}

.sidebar-item {
width: 50px;
height: 50px;
background: #ffffff;
border: 2px solid #e9ecef;
border-radius: 50%;
color: #6c757d;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
font-size: 20px;
text-decoration: none;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.sidebar-item:hover {
background: #667eea;
color: white;
border-color: #667eea;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.sidebar-item.active {
background: #667eea;
color: white;
border-color: #667eea;
}

.sidebar-item.primary {
background: #667eea;
color: white;
border-color: #667eea;
box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.sidebar-item.primary:hover {
background: #5a6fd8;
border-color: #5a6fd8;
transform: translateY(-2px);
}

/* Main Content */
.main-content {
flex: 1;
display: flex;
flex-direction: column;
padding: 40px;
background: #ffffff;
}

/* Timer Section */
.timer-section {
display: flex;
align-items: center;
gap: 30px;
margin-bottom: 20px;
}

.timer-display {
font-size: 6rem;
font-weight: 300;
font-variant-numeric: tabular-nums;
color: #333;
transition: all 0.3s ease;
line-height: 1;
min-width: 300px;
}

.timer-display.running {
animation: pulse 2s ease-in-out infinite;
color: #667eea;
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.02); }
}

.timer-controls {
display: flex;
flex-direction: column;
gap: 15px;
}

.time-dropdown {
background: #ffffff;
border: 2px solid #e9ecef;
border-radius: 15px;
color: #333;
padding: 16px 20px;
font-size: 16px;
font-weight: 500;
min-width: 180px;
transition: all 0.3s ease;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
cursor: pointer;
appearance: none;
background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
background-repeat: no-repeat;
background-position: right 16px center;
background-size: 16px;
padding-right: 45px;
}

.time-dropdown:hover {
border-color: #667eea;
box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
transform: translateY(-1px);
}

.time-dropdown:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 6px 20px rgba(102, 126, 234, 0.15);
transform: translateY(-1px);
}

.time-dropdown option {
background: #ffffff;
color: #333;
padding: 12px;
font-weight: 500;
}

.session-info {
font-size: 18px;
color: #6c757d;
font-weight: 500;
}

/* Countdown Display */
.countdown-display {
font-family: 'Comfortaa', 'Fredoka One', 'Nunito', 'Orbitron', sans-serif;
font-size: 8rem;
font-weight: 700;
font-variant-numeric: tabular-nums;
color: #333;
transition: all 0.3s ease;
line-height: 1;
margin-top: 3rem;
margin-bottom: 3rem;
text-align: left;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
letter-spacing: -2px;
}

.countdown-display.running {
animation: pulse 2s ease-in-out infinite;
color: #667eea;
}

/* Font style options - you can switch between these */
.countdown-display.font-comfortaa {
font-family: 'Comfortaa', sans-serif;
font-weight: 700;
}

.countdown-display.font-orbitron {
font-family: 'Orbitron', monospace;
font-weight: 600;
letter-spacing: 1px;
}

.countdown-display.font-fredoka {
font-family: 'Fredoka One', cursive;
font-weight: 400;
letter-spacing: -1px;
}

.countdown-display.font-nunito {
font-family: 'Nunito', sans-serif;
font-weight: 800;
letter-spacing: -1px;
}

/* Controls */
.controls {
display: flex;
gap: 20px;
margin-bottom: 40px;
}

.control-btn {
background: #ffffff;
border: 2px solid #e9ecef;
color: #6c757d;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 500;
transition: all 0.3s ease;
min-width: 120px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.control-btn:hover {
background: #f8f9fa;
border-color: #667eea;
color: #667eea;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
}

.control-btn.primary {
background: #667eea;
border-color: #667eea;
color: white;
box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.control-btn.primary:hover {
background: #5a6fd8;
border-color: #5a6fd8;
transform: translateY(-2px);
}

.control-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

/* Session Type Selector */
.session-selector {
display: flex;
justify-content: flex-start;
background: #f8f9fa;
border: 1px solid #e9ecef;
border-radius: 25px;
padding: 5px;
margin-bottom: 30px;
max-width: 300px;
}

.session-btn {
background: transparent;
border: none;
color: #6c757d;
padding: 12px 30px;
border-radius: 20px;
cursor: pointer;
font-size: 16px;
font-weight: 500;
transition: all 0.3s ease;
flex: 1;
}

.session-btn.active {
background: #667eea;
color: white;
box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.session-btn:hover:not(.active) {
color: #667eea;
background: rgba(102, 126, 234, 0.1);
}

/* Remove old time inputs */
.time-inputs {
display: none;
}

/* Empty State */
.empty-state {
display: flex;
align-items: center;
justify-content: center;
height: 60vh;
text-align: center;
}

.empty-state-content {
max-width: 400px;
}

.empty-icon {
font-size: 4rem;
margin-bottom: 20px;
opacity: 0.6;
}

.empty-state h2 {
font-size: 2rem;
color: #333;
margin-bottom: 15px;
font-weight: 600;
}

.empty-state p {
font-size: 1.1rem;
color: #6c757d;
line-height: 1.6;
}

/* Modal Styles */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
backdrop-filter: blur(5px);
}

.modal {
background: white;
border-radius: 20px;
width: 90%;
max-width: 500px;
max-height: 90vh;
overflow-y: auto;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
}
to {
    opacity: 1;
    transform: translateY(0) scale(1);
}
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 25px 30px 20px;
border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
font-size: 1.5rem;
color: #333;
font-weight: 600;
margin: 0;
}

.modal-close {
background: none;
border: none;
font-size: 2rem;
color: #6c757d;
cursor: pointer;
padding: 0;
width: 30px;
height: 30px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 50%;
transition: all 0.3s ease;
}

.modal-close:hover {
background: #f8f9fa;
color: #333;
}

.modal-body {
padding: 30px;
}

.form-group {
margin-bottom: 25px;
}

.form-group label {
display: block;
font-weight: 600;
color: #333;
margin-bottom: 8px;
font-size: 14px;
}

.form-group select,
.form-group input,
.form-group textarea {
width: 100%;
padding: 12px 16px;
border: 2px solid #e9ecef;
border-radius: 10px;
font-size: 16px;
transition: all 0.3s ease;
background: white;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
resize: vertical;
min-height: 80px;
}

.modal-footer {
display: flex;
gap: 15px;
padding: 20px 30px 30px;
justify-content: flex-end;
}

.modal-btn {
padding: 12px 24px;
border-radius: 10px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
border: 2px solid transparent;
}

.modal-btn.secondary {
background: #f8f9fa;
color: #6c757d;
border-color: #e9ecef;
}

.modal-btn.secondary:hover {
background: #e9ecef;
color: #333;
}

.modal-btn.primary {
background: #667eea;
color: white;
border-color: #667eea;
}

.modal-btn.primary:hover {
background: #5a6fd8;
border-color: #5a6fd8;
transform: translateY(-1px);
}

/* Responsive */
@media (max-width: 768px) {
.sidebar {
    width: 60px;
}

.sidebar-item {
    width: 40px;
    height: 40px;
    font-size: 16px;
}

.timer-section {
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
}

.timer-display {
    font-size: 4rem;
    min-width: auto;
}

.main-content {
    padding: 20px;
}

.controls {
    flex-direction: column;
    align-items: flex-start;
}

.session-selector {
    max-width: 100%;
}

.time-dropdown {
    min-width: 160px;
    font-size: 16px;
    padding: 15px 20px;
    padding-right: 45px;
}

.countdown-display {
    font-size: 6rem;
}

.modal {
    width: 95%;
    margin: 20px;
}

.modal-header,
.modal-body,
.modal-footer {
    padding: 20px;
}

.modal-footer {
    flex-direction: column;
}

.modal-btn {
    width: 100%;
    margin-bottom: 10px;
}
}

.modal-btn.primary {
  position: relative;
  transition: color 0.2s;
}

/* Spinner styles for loading state */
.modal-btn.primary.button--loading {
  color: transparent; /* hides text, spinner appears over center */
}

/* Spinner pseudo-element */
.modal-btn.primary.button--loading::after {
  content: "";
  position: absolute;
  top: 50%; left: 50%;
  width: 22px; height: 22px;
  margin-left: -11px; margin-top: -11px;
  border: 3px solid #fff;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.hidden{
    display: none;
}
</style>    
</head>
<body>
    <!-- Left Sidebar -->
    <div class="sidebar">
        <button class="sidebar-item primary" onclick="createNewSession()" title="Create New Session">+</button>
        <a href="/profile" class="sidebar-item" title="Profile">üë§</a>
        <a href="/stats" class="sidebar-item" title="Stats">üìä</a>
        <button class="sidebar-item" onclick="logout()" title="Logout">üö™</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-content">
                <div class="empty-icon">‚è∞</div>
                <h2>Ready to Start Studying?</h2>
                <p>Click the + button in the sidebar to create your first study session</p>
            </div>`
        </div>

        

    </div>

    <!-- Session Creation Modal -->
    <div class="modal-overlay" id="sessionModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Create New Session</h3>
                <button class="modal-close" onclick="closeSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sessionForm">
                    <div class="form-group">
                        <label for="sessionName">Session Name</label>
                        <input type="text" id="sessionName" name="sessionName" placeholder="e.g., Math Study Session" required>
                    </div>
                    <div class="form-group">
                        <label for="studyMinutes">Study Minutes</label>
                        <select id="studyMins" name="studyMinutes" required>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="20">20 minutes</option>
                            <option value="25" selected>25 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="breakMinutes">Break Minutes</label>
                        <select id="breakMins" name="breakMinutes" required>
                            <option value="5" selected>5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="20">20 minutes</option>
                            <option value="25">25 minutes</option>
                            <option value="30">30 minutes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numCycles">Number of cycles:</label>
                        <select id="numCycles" name="numCycles" required>
                            <option value="4" selected>4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeSessionModal()">Cancel</button>
                <button type="button" class="modal-btn primary" id="createSessionBtn" onclick="createSession()">Create Session</button>

            </div>
        </div>
    </div>

    <script>
        window.onload = async function() {
        const response = await fetch('/api/sessions');
        if (response.status === 401) {
            window.location.href = '/login';
            return;
        }

        const sessionRaw = sessionStorage.getItem('currentSession');
        const currentSession = sessionRaw ? JSON.parse(sessionRaw) : null;

        if (currentSession && Object.keys(currentSession).length > 0) {
            let mainDiv = document.getElementById('emptyState');
            mainDiv.innerHTML = `
                <div id="sessionPrompt" class="session-prompt">
                    <div class="prompt-content">
                        <div class="prompt-icon">‚è∞</div>
                        <h3>Use your Saved Session?</h3>
                        <p>You have an unstarted study session. Would you like to start it now?</p>
                        <div class="prompt-actions">
                            <button class="prompt-btn primary" onclick="StartSession()">Start Session</button>
                            <button class="prompt-btn secondary" onclick="dismissSessionPrompt()">Dismiss</button>
                        </div>
                    </div>
                </div>
            `;
        }
    }


    async function StartSession(){
        // Parse currentSession inside the function!
        const sessionRaw = sessionStorage.getItem('currentSession');
        const currentSession = sessionRaw ? JSON.parse(sessionRaw) : null;
        const response = await fetch(`api/sessions/${currentSession._id}/start`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            console.log('Session started:', result);
        } else {
            const error = await response.json();
            console.error('Failed to start session:', error);
        }
        makeSessionPlan()
        const sessionPlan = JSON.parse(sessionStorage.getItem("sessionPlan"));
        executeSessionPlan(sessionPlan);
    }

function makeSessionPlan(){
    let sessionPlan = [];
    let sessionData = JSON.parse(sessionStorage.getItem('currentSession'));
    for(let i=0; i < sessionData.numCycles; i++){
        sessionPlan.push({type: 'Study', minutes: sessionData.studyMins });
        if (i < sessionData.numCycles - 1){
            sessionPlan.push({type: 'Break', minutes: sessionData.breakMins });
        }
    }
    sessionStorage.setItem('sessionPlan', JSON.stringify(sessionPlan));
}


function executeSessionPlan(sessionPlan) {
    let current = 0;
    function nextSegment() {
    const next = sessionPlan[current + 1] || null; // üëà this defines next!
    if (current < sessionPlan.length) {
        displayCountdown(sessionPlan[current], nextSegment, next); // pass next segment info!
        current++;
    } else {
        document.getElementById('emptyState').innerHTML = "<div style='font-size:2rem'>Session complete! üéâ</div>";
    }
}
    nextSegment();
}


function displayCountdown(segment, onComplete, nextSegment) {
    let time = segment.minutes * 60;
    const countdownDisplay = document.getElementById('emptyState');
    let timer;

    // Helper to stop the timer and optionally go to next segment
    function stopTimer() {
        clearInterval(timer);
        countdownDisplay.innerHTML = `${segment.type} stopped!`;
    }
    function skipSegment() {
        clearInterval(timer);
        if (typeof onComplete === 'function') onComplete();
    }

    function render() {
        let minutes = Math.floor(time / 60);
        let seconds = time % 60;
        let nextHtml = '';
        if (nextSegment) {
            nextHtml = `
                <div style="margin-top:16px;font-size:1.08rem;color:#667eea;">
                  Next: <b>${nextSegment.type}</b> ‚Äì ${nextSegment.minutes} min
                </div>`;
        }

        countdownDisplay.innerHTML = `
            <div style="font-size:2.6rem;margin-bottom:10px">${segment.type}: ${minutes}:${seconds.toString().padStart(2, '0')}</div>
            <div style="margin-top:14px">
                <button onclick="window._stopCountdown && window._stopCountdown()" class="control-btn" style="margin-right:8px;">Stop</button>
                <button onclick="window._skipCountdown && window._skipCountdown()" class="control-btn primary">Skip</button>
            </div>
            ${nextHtml}
        `;
    }

    // Expose control functions globally for button onclick use
    window._stopCountdown = stopTimer;
    window._skipCountdown = skipSegment;

    render(); // Update UI first frame
    timer = setInterval(() => {
        time--;
        render();
        if (time < 0) {
            clearInterval(timer);
            if (typeof onComplete === 'function') onComplete();
        }
    }, 1000);
}





// DOM elements
//createsession function
// Create session from modal
async function createSession(){
    mainDiv = document.getElementById('emptyState');
    mainDiv.classList.add('hidden');
    const btn = document.getElementById('createSessionBtn');
    btn.classList.add('button--loading');
    try {
        const sessionName = document.getElementById('sessionName').value;
        const studyMins = document.getElementById('studyMins').value;
        const breakMins = document.getElementById('breakMins').value;
        const numCycles = document.getElementById('numCycles').value;
        
        sessionData = {
            sessionName,
            studyMins,
            breakMins,
            numCycles
        };
        console.log(sessionData);

        const sessionJson = JSON.stringify(sessionData);

        //api/session call
        const response = await fetch('/api/sessions', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: sessionJson
        });
        const data = await response.json();
        sessionStorage.setItem('currentSession', JSON.stringify(data));
        alert(`session data was saved to session storage`);
        closeSessionModal();
        window.location.reload();

    }catch (err) {
        alert(`Your sesssion was not created. See the error message: ${err}`)
    }
}



// Logout function
async function logout() {
    try {
        const response = await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.ok) {
            window.location.href = '/login';
        } else {
            alert('Logout failed. Please try again.');
        }
    } catch (error) {
        console.error('Logout error:', error);
        alert('Network error during logout.');
    }
}


// Start new session function - now opens modal
function createNewSession() {
    openSessionModal();
}

// Modal functions
function openSessionModal() {
    document.getElementById('sessionModal').style.display = 'flex';
}

function closeSessionModal() {
    document.getElementById('sessionModal').style.display = 'none';
    // Reset form
    document.getElementById('sessionForm').reset();
}

// Cycle through different fonts
function cycleFont() {
    // Remove current font class
    fontOptions.forEach(font => countdownDisplay.classList.remove(font));
    
    // Move to next font
    currentFontIndex = (currentFontIndex + 1) % fontOptions.length;
    
    // Add new font class
    countdownDisplay.classList.add(fontOptions[currentFontIndex]);
    
    // Update button text to show current font
    const fontNames = ['Comfortaa', 'Orbitron', 'Fredoka', 'Nunito'];
    document.getElementById('fontBtn').textContent = `üé® ${fontNames[currentFontIndex]}`;
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('sessionModal');
    if (e.target === modal) {
        closeSessionModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeSessionModal();
    }
});

// Initialize
timeLeft = parseInt(countdownDisplay.value) * 60;
updateDefaultTimes();
updateTimerDisplay();
    </script>
</body>
</html>